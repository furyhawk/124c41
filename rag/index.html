<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>rag - 124c41</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">124c41</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../resume/" class="nav-link">Resume</a>
                            </li>
                            <li class="nav-item">
                                <a href="../conda/" class="nav-link">Conda</a>
                            </li>
                            <li class="nav-item">
                                <a href="../venv/" class="nav-link">venv</a>
                            </li>
                            <li class="nav-item">
                                <a href="../poetry/" class="nav-link">poetry</a>
                            </li>
                            <li class="nav-item">
                                <a href="../git/" class="nav-link">git</a>
                            </li>
                            <li class="nav-item">
                                <a href="../ssh/" class="nav-link">ssh</a>
                            </li>
                            <li class="nav-item">
                                <a href="../softwarearchitecture/" class="nav-link">softwarearchitecture</a>
                            </li>
                            <li class="nav-item">
                                <a href="../code/" class="nav-link">vscode</a>
                            </li>
                            <li class="nav-item">
                                <a href="../machine_learning/" class="nav-link">machine_learning</a>
                            </li>
                            <li class="nav-item">
                                <a href="../llm/" class="nav-link">llm</a>
                            </li>
                            <li class="nav-item">
                                <a href="../embedding/" class="nav-link">embedding</a>
                            </li>
                            <li class="nav-item">
                                <a href="../llama2/" class="nav-link">llmama2</a>
                            </li>
                            <li class="nav-item">
                                <a href="../ollama/" class="nav-link">ollama</a>
                            </li>
                            <li class="nav-item">
                                <a href="./" class="nav-link active" aria-current="page">rag</a>
                            </li>
                            <li class="nav-item">
                                <a href="../framework/" class="nav-link">Framework</a>
                            </li>
                            <li class="nav-item">
                                <a href="../db/" class="nav-link">database</a>
                            </li>
                            <li class="nav-item">
                                <a href="../dataframe/" class="nav-link">Dataframe</a>
                            </li>
                            <li class="nav-item">
                                <a href="../chart/" class="nav-link">Chart</a>
                            </li>
                            <li class="nav-item">
                                <a href="../anomaly_detection/" class="nav-link">anomaly_detection</a>
                            </li>
                            <li class="nav-item">
                                <a href="../hydra/" class="nav-link">Hydra</a>
                            </li>
                            <li class="nav-item">
                                <a href="../linux/" class="nav-link">Linux</a>
                            </li>
                            <li class="nav-item">
                                <a href="../docker/" class="nav-link">Docker</a>
                            </li>
                            <li class="nav-item">
                                <a href="../k8s/" class="nav-link">Kubernetes</a>
                            </li>
                            <li class="nav-item">
                                <a href="../ceph/" class="nav-link">ceph</a>
                            </li>
                            <li class="nav-item">
                                <a href="../macos/" class="nav-link">macos</a>
                            </li>
                            <li class="nav-item">
                                <a href="../sway/" class="nav-link">sway</a>
                            </li>
                            <li class="nav-item">
                                <a href="../mqtt/" class="nav-link">mqtt</a>
                            </li>
                            <li class="nav-item">
                                <a href="../jetson/" class="nav-link">jetson</a>
                            </li>
                            <li class="nav-item">
                                <a href="../yolox/" class="nav-link">yolox</a>
                            </li>
                            <li class="nav-item">
                                <a href="../gpt/" class="nav-link">gpt</a>
                            </li>
                            <li class="nav-item">
                                <a href="../stable_diffusion/" class="nav-link">stable_diffussion</a>
                            </li>
                            <li class="nav-item">
                                <a href="../wandb/" class="nav-link">Model Analysis</a>
                            </li>
                            <li class="nav-item">
                                <a href="../smb/" class="nav-link">Samba</a>
                            </li>
                            <li class="nav-item">
                                <a href="../smb2/" class="nav-link">Samba_ubuntu</a>
                            </li>
                            <li class="nav-item">
                                <a href="../mkdocs/" class="nav-link">MkDocs</a>
                            </li>
                            <li class="nav-item">
                                <a href="../mypy/" class="nav-link">mypy</a>
                            </li>
                            <li class="nav-item">
                                <a href="../literatures/" class="nav-link">Literatures</a>
                            </li>
                            <li class="nav-item">
                                <a href="../scrape_pad/" class="nav-link">scrape_pad</a>
                            </li>
                            <li class="nav-item">
                                <a href="../nes/" class="nav-link">nes</a>
                            </li>
                            <li class="nav-item">
                                <a href="../time_travel/" class="nav-link">time_travel</a>
                            </li>
                            <li class="nav-item">
                                <a href="../random/" class="nav-link">random</a>
                            </li>
                            <li class="nav-item">
                                <a href="../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../ollama/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../framework/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="true">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#rag" class="nav-link">RAG</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#huggingface" class="nav-link">Huggingface</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#langchain" class="nav-link">langchain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="rag">RAG</h1>
<h2 id="huggingface">Huggingface</h2>
<p>Retriever used to get documents from vector queries. It retrieves the documents embeddings as well as the documents contents, and it formats them to be used with a RagModel.</p>
<p>Examples:</p>
<pre><code class="language-python"># To load the default &quot;wiki_dpr&quot; dataset with 21M passages from wikipedia (index name is 'compressed' or 'exact')
from transformers import RagRetriever

retriever = RagRetriever.from_pretrained(
    &quot;facebook/dpr-ctx_encoder-single-nq-base&quot;, dataset=&quot;wiki_dpr&quot;, index_name=&quot;compressed&quot;
)

# To load your own indexed dataset built with the datasets library. More info on how to build the indexed dataset in examples/rag/use_own_knowledge_dataset.py
from transformers import RagRetriever

dataset = (
    ...
)  # dataset must be a datasets.Datasets object with columns &quot;title&quot;, &quot;text&quot; and &quot;embeddings&quot;, and it must have a faiss index
retriever = RagRetriever.from_pretrained(&quot;facebook/dpr-ctx_encoder-single-nq-base&quot;, indexed_dataset=dataset)

# To load your own indexed dataset built with the datasets library that was saved on disk. More info in examples/rag/use_own_knowledge_dataset.py
from transformers import RagRetriever

dataset_path = &quot;path/to/my/dataset&quot;  # dataset saved via *dataset.save_to_disk(...)*
index_path = &quot;path/to/my/index.faiss&quot;  # faiss index saved via *dataset.get_index(&quot;embeddings&quot;).save(...)*
retriever = RagRetriever.from_pretrained(
    &quot;facebook/dpr-ctx_encoder-single-nq-base&quot;,
    index_name=&quot;custom&quot;,
    passages_path=dataset_path,
    index_path=index_path,
)

# To load the legacy index built originally for Rag's paper
from transformers import RagRetriever

retriever = RagRetriever.from_pretrained(&quot;facebook/dpr-ctx_encoder-single-nq-base&quot;, index_name=&quot;legacy&quot;)
</code></pre>
<p>RAG is a seq2seq model which encapsulates two core components: a question encoder and a generator. During a forward pass, we encode the input with the question encoder and pass it to the retriever to extract relevant context documents. The documents are then prepended to the input. Such contextualized inputs is passed to the generator.</p>
<pre><code class="language-python">from transformers import AutoTokenizer, RagRetriever, RagModel
import torch

tokenizer = AutoTokenizer.from_pretrained(&quot;facebook/rag-token-base&quot;)
retriever = RagRetriever.from_pretrained(
    &quot;facebook/rag-token-base&quot;, index_name=&quot;exact&quot;, use_dummy_dataset=True
)
# initialize with RagRetriever to do everything in one forward call
model = RagModel.from_pretrained(&quot;facebook/rag-token-base&quot;, retriever=retriever)

inputs = tokenizer(&quot;How many people live in Paris?&quot;, return_tensors=&quot;pt&quot;)
outputs = model(input_ids=inputs[&quot;input_ids&quot;])
</code></pre>
<pre><code class="language-python">from transformers import AutoTokenizer, RagRetriever, RagSequenceForGeneration
import torch

tokenizer = AutoTokenizer.from_pretrained(&quot;facebook/rag-sequence-nq&quot;)
retriever = RagRetriever.from_pretrained(
    &quot;facebook/rag-sequence-nq&quot;, index_name=&quot;exact&quot;, use_dummy_dataset=True
)
# initialize with RagRetriever to do everything in one forward call
model = RagSequenceForGeneration.from_pretrained(&quot;facebook/rag-token-nq&quot;, retriever=retriever)

inputs = tokenizer(&quot;How many people live in Paris?&quot;, return_tensors=&quot;pt&quot;)
targets = tokenizer(text_target=&quot;In Paris, there are 10 million people.&quot;, return_tensors=&quot;pt&quot;)
input_ids = inputs[&quot;input_ids&quot;]
labels = targets[&quot;input_ids&quot;]
outputs = model(input_ids=input_ids, labels=labels)

# or use retriever separately
model = RagSequenceForGeneration.from_pretrained(&quot;facebook/rag-sequence-nq&quot;, use_dummy_dataset=True)
# 1. Encode
question_hidden_states = model.question_encoder(input_ids)[0]
# 2. Retrieve
docs_dict = retriever(input_ids.numpy(), question_hidden_states.detach().numpy(), return_tensors=&quot;pt&quot;)
doc_scores = torch.bmm(
    question_hidden_states.unsqueeze(1), docs_dict[&quot;retrieved_doc_embeds&quot;].float().transpose(1, 2)
).squeeze(1)
# 3. Forward to generator
outputs = model(
    context_input_ids=docs_dict[&quot;context_input_ids&quot;],
    context_attention_mask=docs_dict[&quot;context_attention_mask&quot;],
    doc_scores=doc_scores,
    decoder_input_ids=labels,
)
</code></pre>
<h2 id="langchain">langchain</h2>
<p>https://python.langchain.com/docs/expression_language/cookbook/retrieval</p>
<p>Let's look at adding in a retrieval step to a prompt and LLM, which adds up to a "retrieval-augmented generation" chain</p>
<pre><code class="language-sh">pip install langchain openai faiss-cpu tiktoken
``````

```python
from operator import itemgetter

from langchain.prompts import ChatPromptTemplate
from langchain.chat_models import ChatOpenAI
from langchain.embeddings import OpenAIEmbeddings
from langchain.schema.output_parser import StrOutputParser
from langchain.schema.runnable import RunnablePassthrough
from langchain.vectorstores import FAISS

vectorstore = FAISS.from_texts([&quot;harrison worked at kensho&quot;], embedding=OpenAIEmbeddings())
retriever = vectorstore.as_retriever()

template = &quot;&quot;&quot;Answer the question based only on the following context:
{context}

Question: {question}
&quot;&quot;&quot;
prompt = ChatPromptTemplate.from_template(template)

model = ChatOpenAI()

chain = (
    {&quot;context&quot;: retriever, &quot;question&quot;: RunnablePassthrough()} 
    | prompt 
    | model 
    | StrOutputParser()
)
chain.invoke(&quot;where did harrison work?&quot;)

template = &quot;&quot;&quot;Answer the question based only on the following context:
{context}

Question: {question}

Answer in the following language: {language}
&quot;&quot;&quot;
prompt = ChatPromptTemplate.from_template(template)

chain = {
    &quot;context&quot;: itemgetter(&quot;question&quot;) | retriever, 
    &quot;question&quot;: itemgetter(&quot;question&quot;), 
    &quot;language&quot;: itemgetter(&quot;language&quot;)
} | prompt | model | StrOutputParser()

chain.invoke({&quot;question&quot;: &quot;where did harrison work&quot;, &quot;language&quot;: &quot;italian&quot;})



</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
