<!doctype html>
<html lang="en">

<head>
        <title>rag - 124c41</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="../assets/css/darcula-highlight.min.css">

        <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
        <link rel="stylesheet" href="../assets/css/dracula-ui.min.css">
        <link rel="stylesheet" href="../assets/css/mkdocs.min.css">

        
            <link  rel="icon" type="image/x-icon" href="../assets/img/favicon.ico">
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
                <script>hljs.initHighlightingOnLoad();</script>

</head>

<body class="drac-bg-black-secondary drac-text-grey-ternary drac-text drac-scrollbar-purple">

    <main class="d-flex">

        <!-- block sidebar -->
            <nav id="sidebar" class="sidebar drac-bg-black">
    <div class="custom-menu">
        <button type="button" id="sidebarCollapse" class="btn btn-primary">
            <i class="fa fa-bars"></i>
            <span class="sr-only">Menu</span>
        </button>
    </div>

    <div class="p-4">
        

        <div class="drac-text-center">
            
                <span class="drac-text drac-line-height drac-text-white">124c41</span>
            
        </div>

        <div class="drac-box flex-column">
            <ul class="dot-ul">
                <li><div class="dot-li drac-bg-cyan"></div></li>
                <li><div class="dot-li drac-bg-green"></div></li>
                <li><div class="dot-li drac-bg-orange"></div></li>
                <li><div class="dot-li drac-bg-pink"></div></li>
                <li><div class="dot-li drac-bg-purple"></div></li>
                <li><div class="dot-li drac-bg-red"></div></li>
                <li><div class="dot-li drac-bg-yellow"></div></li>
            </ul>
        </div>

        <hr class="drac-divider" />

        <!-- block menu -->
        <ul class="mb-5 drac-list drac-list-none">
            
            <li class="drac-box">
                <a href=".."
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Home
                </a>
            </li>
            <li class="drac-box">
                <a href="../resume/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Resume
                </a>
            </li>
            <li class="drac-box">
                <a href="../conda/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Conda
                </a>
            </li>
            <li class="drac-box">
                <a href="../venv/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    venv
                </a>
            </li>
            <li class="drac-box">
                <a href="../poetry/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    poetry
                </a>
            </li>
            <li class="drac-box">
                <a href="../git/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    git
                </a>
            </li>
            <li class="drac-box">
                <a href="../ssh/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    ssh
                </a>
            </li>
            <li class="drac-box">
                <a href="../softwarearchitecture/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    softwarearchitecture
                </a>
            </li>
            <li class="drac-box">
                <a href="../code/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    vscode
                </a>
            </li>
            <li class="drac-box">
                <a href="../machine_learning/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    machine_learning
                </a>
            </li>
            <li class="drac-box">
                <a href="../llm/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    llm
                </a>
            </li>
            <li class="drac-box">
                <a href="../embedding/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    embedding
                </a>
            </li>
            <li class="drac-box">
                <a href="../llama2/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    llmama2
                </a>
            </li>
            <li class="drac-box">
                <a href="../ollama/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    ollama
                </a>
            </li>
            <li class="drac-box">
                <a href="./"
                    class=" active 
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    rag
                </a>
            </li>
            <li class="drac-box">
                <a href="../framework/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Framework
                </a>
            </li>
            <li class="drac-box">
                <a href="../db/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    database
                </a>
            </li>
            <li class="drac-box">
                <a href="../dataframe/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Dataframe
                </a>
            </li>
            <li class="drac-box">
                <a href="../chart/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Chart
                </a>
            </li>
            <li class="drac-box">
                <a href="../anomaly_detection/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    anomaly_detection
                </a>
            </li>
            <li class="drac-box">
                <a href="../hydra/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Hydra
                </a>
            </li>
            <li class="drac-box">
                <a href="../linux/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Linux
                </a>
            </li>
            <li class="drac-box">
                <a href="../docker/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Docker
                </a>
            </li>
            <li class="drac-box">
                <a href="../k8s/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Kubernetes
                </a>
            </li>
            <li class="drac-box">
                <a href="../ceph/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    ceph
                </a>
            </li>
            <li class="drac-box">
                <a href="../macos/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    macos
                </a>
            </li>
            <li class="drac-box">
                <a href="../sway/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    sway
                </a>
            </li>
            <li class="drac-box">
                <a href="../mqtt/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    mqtt
                </a>
            </li>
            <li class="drac-box">
                <a href="../jetson/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    jetson
                </a>
            </li>
            <li class="drac-box">
                <a href="../yolox/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    yolox
                </a>
            </li>
            <li class="drac-box">
                <a href="../gpt/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    gpt
                </a>
            </li>
            <li class="drac-box">
                <a href="../stable_diffusion/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    stable_diffussion
                </a>
            </li>
            <li class="drac-box">
                <a href="../wandb/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Model Analysis
                </a>
            </li>
            <li class="drac-box">
                <a href="../smb/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Samba
                </a>
            </li>
            <li class="drac-box">
                <a href="../smb2/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Samba_ubuntu
                </a>
            </li>
            <li class="drac-box">
                <a href="../mkdocs/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    MkDocs
                </a>
            </li>
            <li class="drac-box">
                <a href="../mypy/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    mypy
                </a>
            </li>
            <li class="drac-box">
                <a href="../literatures/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    Literatures
                </a>
            </li>
            <li class="drac-box">
                <a href="../scrape_pad/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    scrape_pad
                </a>
            </li>
            <li class="drac-box">
                <a href="../nes/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    nes
                </a>
            </li>
            <li class="drac-box">
                <a href="../time_travel/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    time_travel
                </a>
            </li>
            <li class="drac-box">
                <a href="../random/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    random
                </a>
            </li>
            <li class="drac-box">
                <a href="../about/"
                    class="
                    drac-anchor d-inline-flex align-items-center border-0 drac-text-purple--hover">
                    About
                </a>
            </li>
        </ul>
        <!-- endblock -->
    </div>
</nav>
        <!-- endblock -->

        <nav class="divider drac-bg-purple-cyan"></nav>

        <div class="content">
            <!-- block header -->
                <header>
    <nav class="navbar navbar-expand-xl drac-bg-purple">
        <div class="container-fluid">
            
            <button class="navbar-toggler w-100 text-center" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMenu"
                aria-controls="navbarsMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse flex-column ml-auto" id="navbarsMenu">
                <ul class="navbar-nav text-md-center">

                    <!-- block preview -->
                    <li class="nav-item">
                            
        <div class="container">
            <div class="row row-preview">
                <div class="col">
                    <a href="../ollama/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </div>
                <div class="col">
                    <a href="../framework/"
                        class="btn-preview drac-btn drac-btn-outline drac-text-white drac-text-cyan-green--hover" style="padding-left: 3%;">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
                    </li>
                    <!--  endblock -->

                    <!-- block search -->
                    <li class="nav-item"><div role="search" class="search-box">
	<form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
		<input type="text" name="q" class="drac-input drac-input-search drac-input-white drac-text-white drac-bg-black-secondary"
		placeholder="Search docs" title="Type search term here" />
	</form>
</div>
                    </li>
                    <!--  endblock -->

                    <!-- block source -->
                    <li class="nav-item">
                        
                    </li>
                    <!--  endblock -->

                </ul>
            </div>

        </div>
    </nav>
</header>
            <!-- endblock -->

            <!-- block content -->
                <section class="p-md-5 section-content">
    <article>
        <p><h1 id="rag">RAG</h1>
<h2 id="huggingface">Huggingface</h2>
<p>Retriever used to get documents from vector queries. It retrieves the documents embeddings as well as the documents contents, and it formats them to be used with a RagModel.</p>
<p>Examples:</p>
<pre><code class="language-python"># To load the default &quot;wiki_dpr&quot; dataset with 21M passages from wikipedia (index name is 'compressed' or 'exact')
from transformers import RagRetriever

retriever = RagRetriever.from_pretrained(
    &quot;facebook/dpr-ctx_encoder-single-nq-base&quot;, dataset=&quot;wiki_dpr&quot;, index_name=&quot;compressed&quot;
)

# To load your own indexed dataset built with the datasets library. More info on how to build the indexed dataset in examples/rag/use_own_knowledge_dataset.py
from transformers import RagRetriever

dataset = (
    ...
)  # dataset must be a datasets.Datasets object with columns &quot;title&quot;, &quot;text&quot; and &quot;embeddings&quot;, and it must have a faiss index
retriever = RagRetriever.from_pretrained(&quot;facebook/dpr-ctx_encoder-single-nq-base&quot;, indexed_dataset=dataset)

# To load your own indexed dataset built with the datasets library that was saved on disk. More info in examples/rag/use_own_knowledge_dataset.py
from transformers import RagRetriever

dataset_path = &quot;path/to/my/dataset&quot;  # dataset saved via *dataset.save_to_disk(...)*
index_path = &quot;path/to/my/index.faiss&quot;  # faiss index saved via *dataset.get_index(&quot;embeddings&quot;).save(...)*
retriever = RagRetriever.from_pretrained(
    &quot;facebook/dpr-ctx_encoder-single-nq-base&quot;,
    index_name=&quot;custom&quot;,
    passages_path=dataset_path,
    index_path=index_path,
)

# To load the legacy index built originally for Rag's paper
from transformers import RagRetriever

retriever = RagRetriever.from_pretrained(&quot;facebook/dpr-ctx_encoder-single-nq-base&quot;, index_name=&quot;legacy&quot;)
</code></pre>
<p>RAG is a seq2seq model which encapsulates two core components: a question encoder and a generator. During a forward pass, we encode the input with the question encoder and pass it to the retriever to extract relevant context documents. The documents are then prepended to the input. Such contextualized inputs is passed to the generator.</p>
<pre><code class="language-python">from transformers import AutoTokenizer, RagRetriever, RagModel
import torch

tokenizer = AutoTokenizer.from_pretrained(&quot;facebook/rag-token-base&quot;)
retriever = RagRetriever.from_pretrained(
    &quot;facebook/rag-token-base&quot;, index_name=&quot;exact&quot;, use_dummy_dataset=True
)
# initialize with RagRetriever to do everything in one forward call
model = RagModel.from_pretrained(&quot;facebook/rag-token-base&quot;, retriever=retriever)

inputs = tokenizer(&quot;How many people live in Paris?&quot;, return_tensors=&quot;pt&quot;)
outputs = model(input_ids=inputs[&quot;input_ids&quot;])
</code></pre>
<pre><code class="language-python">from transformers import AutoTokenizer, RagRetriever, RagSequenceForGeneration
import torch

tokenizer = AutoTokenizer.from_pretrained(&quot;facebook/rag-sequence-nq&quot;)
retriever = RagRetriever.from_pretrained(
    &quot;facebook/rag-sequence-nq&quot;, index_name=&quot;exact&quot;, use_dummy_dataset=True
)
# initialize with RagRetriever to do everything in one forward call
model = RagSequenceForGeneration.from_pretrained(&quot;facebook/rag-token-nq&quot;, retriever=retriever)

inputs = tokenizer(&quot;How many people live in Paris?&quot;, return_tensors=&quot;pt&quot;)
targets = tokenizer(text_target=&quot;In Paris, there are 10 million people.&quot;, return_tensors=&quot;pt&quot;)
input_ids = inputs[&quot;input_ids&quot;]
labels = targets[&quot;input_ids&quot;]
outputs = model(input_ids=input_ids, labels=labels)

# or use retriever separately
model = RagSequenceForGeneration.from_pretrained(&quot;facebook/rag-sequence-nq&quot;, use_dummy_dataset=True)
# 1. Encode
question_hidden_states = model.question_encoder(input_ids)[0]
# 2. Retrieve
docs_dict = retriever(input_ids.numpy(), question_hidden_states.detach().numpy(), return_tensors=&quot;pt&quot;)
doc_scores = torch.bmm(
    question_hidden_states.unsqueeze(1), docs_dict[&quot;retrieved_doc_embeds&quot;].float().transpose(1, 2)
).squeeze(1)
# 3. Forward to generator
outputs = model(
    context_input_ids=docs_dict[&quot;context_input_ids&quot;],
    context_attention_mask=docs_dict[&quot;context_attention_mask&quot;],
    doc_scores=doc_scores,
    decoder_input_ids=labels,
)
</code></pre>
<h2 id="langchain">langchain</h2>
<p>https://python.langchain.com/docs/expression_language/cookbook/retrieval</p>
<p>Let's look at adding in a retrieval step to a prompt and LLM, which adds up to a "retrieval-augmented generation" chain</p>
<pre><code class="language-sh">pip install langchain openai faiss-cpu tiktoken
``````

```python
from operator import itemgetter

from langchain.prompts import ChatPromptTemplate
from langchain.chat_models import ChatOpenAI
from langchain.embeddings import OpenAIEmbeddings
from langchain.schema.output_parser import StrOutputParser
from langchain.schema.runnable import RunnablePassthrough
from langchain.vectorstores import FAISS

vectorstore = FAISS.from_texts([&quot;harrison worked at kensho&quot;], embedding=OpenAIEmbeddings())
retriever = vectorstore.as_retriever()

template = &quot;&quot;&quot;Answer the question based only on the following context:
{context}

Question: {question}
&quot;&quot;&quot;
prompt = ChatPromptTemplate.from_template(template)

model = ChatOpenAI()

chain = (
    {&quot;context&quot;: retriever, &quot;question&quot;: RunnablePassthrough()} 
    | prompt 
    | model 
    | StrOutputParser()
)
chain.invoke(&quot;where did harrison work?&quot;)

template = &quot;&quot;&quot;Answer the question based only on the following context:
{context}

Question: {question}

Answer in the following language: {language}
&quot;&quot;&quot;
prompt = ChatPromptTemplate.from_template(template)

chain = {
    &quot;context&quot;: itemgetter(&quot;question&quot;) | retriever, 
    &quot;question&quot;: itemgetter(&quot;question&quot;), 
    &quot;language&quot;: itemgetter(&quot;language&quot;)
} | prompt | model | StrOutputParser()

chain.invoke({&quot;question&quot;: &quot;where did harrison work&quot;, &quot;language&quot;: &quot;italian&quot;})



</code></pre></p>
    </article>
</section>
            <!-- endblock -->

            <!-- block footer -->
                <footer>
    <div class="d-flex flex-sm-row justify-content-between py-2 border-top drac-text-black drac-bg-cyan-green">
        <a href="https://github.com/dracula/mkdocs" target="_blank" style="padding-left: 1%;"
            class="footer-text drac-anchor drac-text-black drac-text-purple--hover">
            Made with Dracula Theme for MkDocs
        </a>
    </div>
</footer>
            <!-- endblock -->
        </div>

    </main>

        <script>var base_url = '..';</script>
        <script src="../assets/js/jquery-3.3.1.slim.min.js"></script>
        <script src="../assets/js/bootstrap.bundle.min.js"></script>
        <script src="../assets/js/mkdocs.js"></script>
			<script src="../search/main.js" defer></script>

</body>

</html>